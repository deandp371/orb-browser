<!-- 
orb-browser
Minor planet orbit browser implemented in HTML and Javascript. 
The utility allows a user to input a file containing minor planet 
orbits in the IAU Minor Planet Center (MPC) export format and browse, 
filter and export the entries in the MPCORB or other formats.

Author: David P Dean
Contact: deandp371@gmail.com
Version: 0.5 beta
Date: 2016-07-14
License: Open Source under the Apache 2.0 License
Demo site: TBD
Source Code: GitHub project orb-browser
-->
<html>
<head>
<meta charset="ISO-8859-1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
<link rel="stylesheet" href="css/jquery.dataTables.min.css">
<script src="js/jquery-1.12.3.js"></script>	
<script src="js/jquery.dataTables.min.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<style>
body {
    font-family: Ariel, sans-serif;
    background-color:midnightblue;
    color:white;
}
h1 {
    color: maroon;
    margin-left: 40px;
} 
h2 {
    font-size: 2.0em;
}
p.info {
    font-size: 1.2em;
}
p.norm {
    font-size: 1.0em;
}
div.header {
    font-family: Ariel, sans-serif;
    font-weight: bold;
}

div.info {
    font-family: Ariel, sans-serif;
    font-weight: normal;
}

p.header {
    font-family: Ariel, sans-serif;
    font-weight: bold;
}

div.ob {
	color: midnightblue;
	background-color: white;
}

table {
    border-collapse: collapse;
}

table, th, td {
	color: black;
    border: 1px solid black;
    font-size: 10px;
}
#header {
    text-align:center;
    padding:5px;
}
#section {
    float:left;
    padding:10px; 
    margin-left: 5%;
    margin-right: 5%; 
    margin-bottom: 5%;     
}
#footer {
    background-color:black;
    color:white;
    clear:both;
    text-align:center;
    padding:5px; 
}
</style>
<script>

// reject input line less then this value
var LINE_MIN_LEN = 180;
var tableLoaded = false;
var filteredData;

function readSingleFile(e) {
  var elements = [];
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    lines = e.target.result.split(/\r?\n/);
    displayLineCount(lines.length);
    for(iline = 0; iline < lines.length; ++iline) {
    	var nextLine = lines[iline];
		if( nextLine.length < LINE_MIN_LEN ) {
			continue;
		}
		//console.log("nextline=" + nextLine);
		if( typeof nextLine !== 'undefined' ) {
    		var elem = new element(nextLine);
			elements[iline] = elem;
		}
    }
    //var orbitTable = $('#elemTable').DataTable();
    if( tableLoaded == true ) {
    	console.log("reset the table");
    	orbitTable.clear().rows.add(elements).draw()
    }
    else {
		orbitTable = $('#elemTable').DataTable(
		{
			retrieve: true,
			data: elements,
			columns: [
				{ data: "designationPacked" },
				{ data: "H" },
				{ data: "G" },
				{ data: "epochPacked" },
				{ data: "a" },
				{ data: "e" },
				{ data: "i" },
				{ data: "node" },
				{ data: "peri" },
				{ data: "M" },
				{ data: "n" },
				{ data: "U" },
				{ data: "reference" },
				{ data: "nObservations" },
				{ data: "nOppositions" },
				{ data: "obsInfo" },
				{ data: "residual" },
				{ data: "perturbCoarse" },
				{ data: "perturbPrecise" },
				{ data: "flags" },
				{ className: "select-filter", data: "orbitType" },
				{ className: "select-filter", data: "neoFlag" },
				{ className: "select-filter",data: "km1Flag" },
				{ className: "select-filter",data: "opp1Flag" },
				{ className: "select-filter",data: "critFlag" },
				{ className: "select-filter", data: "phaFlag" },
				{ data: "designation" },
				{ data: "orbitDate" }
			]
		}
	)
	.on('search', function() {
		var rowCount = orbitTable.rows({order:'index', search:'applied'}).data().length;
		console.log('table search row cnt=' + rowCount);
		filteredData = orbitTable.rows({order:'index', search:'applied'}).data();
	})
	.columns( '.select-filter' ).every( function () {
    var that = this;
    // Create the select list and search operation
    //var select = $('<select />')
    var select = $('<select><option value=""></option></select>')
        .appendTo(
            this.footer()
        )
        .on( 'change', function () {
            that
                .search( $(this).val() )
                .draw();
        } );
 
    // Get the search data for the first column and add to the select list
    this
        .cache( 'search' )
        .sort()
        .unique()
        .each( function ( d ) {
            select.append( $('<option value="'+d+'">'+d+'</option>') );
        } );
} );
    }
	tableLoaded = true;
  };
  reader.readAsText(file);

  displayOb();
}

function element(line) {
	//console.log(line);
	this.line = line;
	this.designationPacked =line.slice(0,7).trim(); // designation in packed form text
	this.H = Number(line.slice(8,13));              // absolute magnitude, H numeric
	this.G = Number(line.slice(14,19));             // slope parameter, G numeric
	this.epochPacked = line.slice(20,25).trim();    // epoch packed - text
	
	this.M = Number(line.slice(26,35));             // mean anomoly numeric
	this.peri = Number(line.slice(37,46));          // Argument of perihelion, numeric
	this.node = Number(line.slice(48,57));          // Longitude of the ascending node, numeric
	this.i = Number(line.slice(59,68));   // Inclination to the ecliptic, numeric
	
	this.e = Number(line.slice(70,79));   // Orbital eccentricity, numeric
	this.n = Number(line.slice(80,91));   // mean daily motion, numeric
	this.a = Number(line.slice(92,103));   // semimajor axis, numeric
	
	this.U = line.slice(105,106);   // uncertainty parameter - text

	this.reference = line.slice(107,116);   // reference - text
	
	this.nObservations = Number(line.slice(117,122));   // Number of observations, numeric
	this.nOppositions = Number(line.slice(123,126));   // Number of oppositions, numeric
	
	this.obsInfo = line.slice(127,136);   // first and last obs or number of days
	
	this.residual = Number(line.slice(137,141));   // residual RMS, numeric

	this.perturbCoarse = line.slice(142,145);   // Coarse indicator of perturbers - text
	this.perturbPrecise = line.slice(146,149);   // Precise indicator of perturbers - text

	this.flags = line.slice(161,165);   // Precise indicator of perturbers - text
	this.orbitType = getOrbitType(this.flags);
	this.neoFlag = isNEO(this.flags);
	this.km1Flag = is1KM(this.flags);
	this.opp1Flag = is1Opp(this.flags);
	this.critFlag = isCrit(this.flags);
	this.phaFlag = isPHA(this.flags);
	
	this.designation = line.slice(166,194);   // Readable designation - text
	this.orbitDate = line.slice(194,202);   // Date last obs incl in orbit solution - text
	
	this.toTSV = function() {
		return this.designationPacked + "\t"
			+ this.G + "\t"
			+ this.H
	}
}

// return the orbit type from the hex flags value lower 5 bits

function getOrbitType(flags) {
var typeVal = parseInt(flags,16) & 0x1F;
var typeNames = [
	"Unassigned",
	"Atir",
        "Aten",
        "Apollo",
        "Amor",
        "Object with q < 1.665 AU",
        "Hungaria",
        "Phocaea",
        "Hilda",
        "Jupiter Trojan",
        "Distant object"
	];
var returnType = (typeVal <= 10) ? typeNames[typeVal] : "";
return returnType;
}

// return the NEO flag from the hex flags bit 11

function isNEO(flags) {
var typeVal = parseInt(flags,16) & 0x0800;
var returnType = (typeVal > 0) ? 1 : 0;
return returnType;
}

// return the 1km flag from the hex flags bit 12

function is1KM(flags) {
var typeVal = parseInt(flags,16) & 0x1000;
var returnType = (typeVal > 0) ? 1 : 0;
return returnType;
}

// return the 1 opposition flag from the hex flags bit 13

function is1Opp(flags) {
var typeVal = parseInt(flags,16) & 0x2000;
var returnType = (typeVal > 0) ? 1 : 0;
return returnType;
}

// return the critical list flag from the hex flags bit 14

function isCrit(flags) {
var typeVal = parseInt(flags,16) & 0x4000;
var returnType = (typeVal > 0) ? 1 : 0;
return returnType;
}

// return the PHA flag from the hex flags bit 15

function isPHA(flags) {
var typeVal = parseInt(flags,16) & 0x8000;
var returnType = (typeVal > 0) ? 1 : 0;
return returnType;
}
	
function displayLineCount(count) {
  $('#lineCount').html(count);
}

function init() {
	// show the home div by default and re-show it when Home is clicked
	$('#navHome').click(function(){
		// toggle the nav buttons
	    $('#navHome').addClass('active');
	    $('#navOrbBrowser').removeClass('active');
	    
	    displayHome();
	});	
	
	// hide the table by default and show it when 
	$('#navOrbBrowser').click(function(){
		
	    $('#navOrbBrowser').addClass('active');
	    $('#navHome').removeClass('active');
	    
	    displayOb();
	});	
	
	
    document.getElementById('file-input')
  		.addEventListener('change', readSingleFile, false);
    
    $( "#downloadTsv" ).click(function() {
    	  console.log( "Handler for .click() called." );
  		if( typeof filteredData !== 'undefined' ) {
  			for (var i = 0; i < filteredData.length; i++) {
  				console.log("row " + i + " desig=" + filteredData[i].toTSV());
  			}
  		}
    });
    
	// display home to start
	displayHome();

}

function displayHome() {
    $('#divHome').show();
    $('#divOrbBrowser').hide();
	
}

function displayOb() {
    $('#divHome').hide();
    $('#divOrbBrowser').show();
}

$( document ).ready(function() {
	init();
});
</script>
</head>
<body>
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Table Demo</a>
    </div>
    <ul class="nav navbar-nav">
      <li class="active" id="navHome"><a href="#">Home</a></li>
      <li><a id="navOrbBrowser" href="#">Orb Browser</a></li>
      <li><a href="#">More Info</a></li> 
    </ul>
  </div>
</nav>
<div id="header">
</div>

<div id="section">

  <div id="divHome">
  <p class="info">OrbBrowser is a minor planet orbit browser implemented in HTML and Javascript. 
The utility allows a user to input a file containing minor orbits in the IAU Minor Planet Center
(MPC) export format and browse, filter and export the entries in the MPCORB or other formats.</p>

<p class="norm">Select a local uncompressed file in the MPCOrb format. Note that the
entire MPCOrb database will be too large to load in a client-side browser app but a 
subset such as NEA.txt will work fine. Select "More Info" above for more details
and links to example files</p>
<br>
<input type="file" id="file-input" />&nbsp;
<br>
Line Count:</p>&nbsp;<div id="lineCount" class="info"></div>
  </div>
  <div id="divOrbBrowser" class="ob">
<table id="elemTable" class="display" width="100%">
	<thead>
	<tr>
		<th>Packed Desig</th>
		<th>H</th>
		<th>G</th>
		<th>Epoch</th>
		<th>a</th>
		<th>e</th>
		<th>i</th>
		<th>Node</th>
		<th>Peri</th>
		<th>M</th>
		<th>n</th>
		<th>U</th>
		<th>Ref</th>
		<th>Num_obs</th>
		<th>Num_opps</th>
		<th>Arc Yrs/Len</th>
		<th>rms</th>
		<th>Perturbers</th>
		<th>Perturbers_2</th>
		<th>Hex_flags</th>
		<th>Orbit_type</th>
		<th>NEO_flag</th>
		<th>One_km_flag</th>
		<th>One_opp_flag</th>
		<th>Crit_flag</th>
		<th>PHA_flag</th>
		<th>Designation</th>
		<th>Last_obs</th>
	</tr>
	</thead>
	<tfoot>
	<tr>
		<th>Packed Desig</th>
		<th>H</th>
		<th>G</th>
		<th>Epoch</th>
		<th>a</th>
		<th>e</th>
		<th>i</th>
		<th>Node</th>
		<th>Peri</th>
		<th>M</th>
		<th>n</th>
		<th>U</th>
		<th>Ref</th>
		<th>Num_obs</th>
		<th>Num_opps</th>
		<th>Arc Yrs/Len</th>
		<th>rms</th>
		<th>Perturbers</th>
		<th>Perturbers_2</th>
		<th>Hex_flags</th>
		<th>Orbit_type</th>
		<th>NEO_flag</th>
		<th>One_km_flag</th>
		<th>One_opp_flag</th>
		<th>Crit_flag</th>
		<th>PHA_flag</th>
		<th>Designation</th>
		<th>Last_obs</th>
	</tr>
	</tfoot>
</table>
<br>
<p class="norm">
Select "Home" to load a new file or export the entire or filtered data set by selecting one of the following:</p>
<button type="button" id="downloadTsv">Download TSV</button>
</div>
</div>
<div id="footer">
<p class="info">Copyright © near-earth.net. Hosted in Amazon S3</p>
</div>
</body> 
</html>
